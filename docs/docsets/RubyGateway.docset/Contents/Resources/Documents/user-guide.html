<!DOCTYPE html>
<html lang="en">
  <head>
    <title>User Guide  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset="utf-8">
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
    <script src="js/lunr.min.js" defer></script>
    <script src="js/typeahead.jquery.js" defer></script>
    <script src="js/jazzy.search.js" defer></script>
  </head>
  <body>


    <a title="User Guide  Reference"></a>

    <header class="header">
      <p class="header-col header-col--primary">
        <a class="header-link" href="index.html">
          RubyGateway Docs
        </a>
         (100% documented)
      </p>
    
      <p class="header-col--secondary">
        <form role="search" action="search.json">
          <input type="text" placeholder="Search documentation" data-typeahead>
        </form>
      </p>
    
        <p class="header-col header-col--secondary">
          <a class="header-link" href="https://github.com/johnfairh/RubyGateway">
            <img class="header-icon" src="img/gh.png"/>
            View on GitHub
          </a>
        </p>
    
    </header>

    <p class="breadcrumbs">
      <a class="breadcrumb" href="index.html">RubyGateway Reference</a>
      <img class="carat" src="img/carat.png" />
      User Guide  Reference
    </p>

    <div class="content-wrapper">
      <nav class="navigation">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Guides.html">Guides</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="user-guide.html">User Guide</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="todo.html">TODO</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Main APIs.html">Main APIs</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/RbGateway.html">RbGateway</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/RbGateway/Verbosity.html">– Verbosity</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/RbObject.html">RbObject</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/RbObjectAccess.html">RbObjectAccess</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/RbObjectCollection.html">RbObjectCollection</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Other APIs.html">Other APIs</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other APIs.html#/s:11RubyGateway15RbBlockCallbacka">RbBlockCallback</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/RbBlockRetention.html">RbBlockRetention</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/RbBreak.html">RbBreak</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/RbProc.html">RbProc</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/RbSymbol.html">RbSymbol</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/RbThread.html">RbThread</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/RbThread/UnblockingFunc.html">– UnblockingFunc</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/RbType.html">RbType</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Error Handling.html">Error Handling</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/RbError.html">RbError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/RbError/History.html">– History</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/RbException.html">RbException</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/RbFailableAccess.html">RbFailableAccess</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Swift Interop.html">Swift Interop</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/RbObjectConvertible.html">RbObjectConvertible</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/String.html">String</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/Bool.html">Bool</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/UInt.html">UInt</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/UInt64.html">UInt64</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/UInt32.html">UInt32</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/UInt16.html">UInt16</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/UInt8.html">UInt8</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/Int.html">Int</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/Int64.html">Int64</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/Int32.html">Int32</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/Int16.html">Int16</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/Int8.html">Int8</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/Double.html">Double</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/Float.html">Float</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/Array.html">Array</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/ArraySlice.html">ArraySlice</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/Dictionary.html">Dictionary</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/Set.html">Set</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/Range.html">Range</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/ClosedRange.html">ClosedRange</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/CountableRange.html">CountableRange</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/CountableClosedRange.html">CountableClosedRange</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/RbComplex.html">RbComplex</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/RbRational.html">RbRational</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">

        <section class="section">
          <div class="section-content">
            
            <h1 id='using-rubygateway' class='heading'>Using RubyGateway</h1>

<p>This document contains notes on using RubyGateway.  For installation tips
see <a href="index.html">the README</a>.</p>

<ul>
<li><a href="#general-usage">How to use the framework</a></li>
<li><a href="#how-to">How to do various Ruby tasks</a></li>
<li><a href="#error-handling">Error handling approach</a></li>
<li><a href="#concurrency">Concurrency and multi-threading</a></li>
<li><a href="#caveats-and-gotchas">Health warning</a></li>
<li><a href="#using-the-cruby-api">Using the libruby API</a></li>
<li><a href="#garbage-collection">Garbage collection notes</a></li>
</ul>
<h2 id='general-usage' class='heading'>General Usage</h2>

<p>The Ruby VM is initialized when you first try to use it and shut down when the
process ends.  Load Ruby code using <code><a href="Classes/RbGateway.html#/s:11RubyGateway02RbB0C4loadySS8filename_Sb4wraptKF">RbGateway.load(filename:wrap:)</a></code> or
<code><a href="Classes/RbGateway.html#/s:11RubyGateway02RbB0C7requireSbSS8filename_tKF">RbGateway.require(filename:)</a></code>.  Or just run some Ruby code and get the result
using <code><a href="Classes/RbGateway.html#/s:11RubyGateway02RbB0C4evalAA0C6ObjectCSS4ruby_tKF">RbGateway.eval(ruby:)</a></code>.  There already is a global instance of <code><a href="Classes/RbGateway.html">RbGateway</a></code>
called <code>Ruby</code> so the code looks like:</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">RubyGateway</span>

<span class="k">do</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Ruby</span><span class="o">.</span><span class="nf">eval</span><span class="p">(</span><span class="nv">ruby</span><span class="p">:</span> <span class="s">"'a' * 4"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre>

<p>Create objects using <code><a href="Classes/RbObject.html#/s:11RubyGateway8RbObjectCACSgSS7ofClass_SayAA0cD11Convertible_pSgG4argss17DictionaryLiteralVySSAGG6kwArgstcfc">RbObject.init(ofClass:args:kwArgs:)</a></code>.  Pass Swift types
or <code><a href="Classes/RbObject.html">RbObject</a></code>s to the <code>args</code> parameter.</p>

<p>Use <code><a href="Classes/RbObjectAccess.html#/s:11RubyGateway14RbObjectAccessC4callAA0cD0CSS_SayAA0cD11Convertible_pSgG4argss17DictionaryLiteralVySSAHG6kwArgstKF">RbObjectAccess.call(_:args:kwArgs:)</a></code> to call methods on the object.  See
<code><a href="Classes/RbObjectAccess.html">RbObjectAccess</a></code> for more object operations and variations on <code>call</code> including
passing Swift code as a block.  Again pass Swift types or <code><a href="Classes/RbObject.html">RbObject</a></code>s in the
<code>args</code> parameter.</p>

<p>Use optional initializers to convert from <code><a href="Classes/RbObject.html">RbObject</a></code>s back to Swift types, or
implicitly/explicitly access <code><a href="Classes/RbObject.html#/s:11RubyGateway8RbObjectC11descriptionSSvp">RbObject.description</a></code> if you just want <code><a href="https://developer.apple.com/documentation/swift/string/">String</a></code>.</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">RubyGateway</span>

<span class="k">do</span> <span class="p">{</span>
    <span class="k">try</span> <span class="kt">Ruby</span><span class="o">.</span><span class="nf">require</span><span class="p">(</span><span class="nv">filename</span><span class="p">:</span> <span class="s">"academy"</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">student</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">RbObject</span><span class="p">(</span><span class="nv">ofClass</span><span class="p">:</span> <span class="s">"Academy::Student"</span><span class="p">,</span>
                               <span class="nv">kwArgs</span><span class="p">:</span> <span class="p">[</span><span class="s">"name"</span><span class="p">:</span> <span class="s">"Betty"</span><span class="p">])</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">bettyGpa</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Double</span><span class="p">(</span><span class="n">student</span><span class="o">.</span><span class="nf">get</span><span class="p">(</span><span class="s">"gpa"</span><span class="p">))</span> <span class="p">{</span>
        <span class="nf">processScore</span><span class="p">(</span><span class="nv">gpa</span><span class="p">:</span> <span class="n">bettyGpa</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre>
<h2 id='how-to' class='heading'>How to &hellip;</h2>

<p>A few Ruby-ish tasks.  Lots of these are more long-winded in Swift.  The idea
here though is not to let you write Ruby using Swift: use Ruby to do that!  But
rather to provide a layer that lets you bridge between Ruby and Swift code,
which will sometimes require driving the Ruby code in these ways.</p>
<h3 id='exchange-swift-types' class='heading'>Exchange Swift types</h3>

<p>RubyBridge provides extensions to most Swift types so you can initialize
<code><a href="Classes/RbObject.html">RbObject</a></code>s with them and vice versa, or use them directly as arguments to
<code><a href="Classes/RbObjectAccess.html#/s:11RubyGateway14RbObjectAccessC4callAA0cD0CSS_SayAA0cD11Convertible_pSgG4argss17DictionaryLiteralVySSAHG6kwArgstKF">RbObjectAccess.call(...)</a></code> and friends.  Supported types are:</p>

<ul>
<li><code><a href="https://developer.apple.com/documentation/swift/bool/">Bool</a></code></li>
<li><code><a href="https://developer.apple.com/documentation/swift/string/">String</a></code></li>
<li>Floating point - <code><a href="https://developer.apple.com/documentation/swift/float/">Float</a></code> and <code><a href="https://developer.apple.com/documentation/swift/double/">Double</a></code></li>
<li>Unsigned integer - <code><a href="https://developer.apple.com/documentation/swift/uint/">UInt</a></code>, <code><a href="https://developer.apple.com/documentation/swift/uint64/">UInt64</a></code>, <code><a href="https://developer.apple.com/documentation/swift/uint32/">UInt32</a></code>, <code><a href="https://developer.apple.com/documentation/swift/uint16/">UInt16</a></code>, <code><a href="https://developer.apple.com/documentation/swift/uint8/">UInt8</a></code></li>
<li>Signed integer - <code><a href="https://developer.apple.com/documentation/swift/int/">Int</a></code>, <code><a href="https://developer.apple.com/documentation/swift/int64/">Int64</a></code>, <code><a href="https://developer.apple.com/documentation/swift/int32/">Int32</a></code>, <code><a href="https://developer.apple.com/documentation/swift/int16/">Int16</a></code>, <code><a href="https://developer.apple.com/documentation/swift/int8/">Int8</a></code></li>
<li><code><a href="https://developer.apple.com/documentation/swift/array/">Array</a></code> or <code><a href="https://developer.apple.com/documentation/swift/arrayslice/">ArraySlice</a></code> with supported element type</li>
<li><code><a href="https://developer.apple.com/documentation/swift/dictionary/">Dictionary</a></code> with supported key and value types</li>
<li><code><a href="https://developer.apple.com/documentation/swift/set/">Set</a></code> with supported element type</li>
<li>Range types with supported bound types - <code><a href="https://developer.apple.com/documentation/swift/range/">Range</a></code>, <code><a href="https://developer.apple.com/documentation/swift/countablerange/">CountableRange</a></code>,
<code><a href="https://developer.apple.com/documentation/swift/closedrange/">ClosedRange</a></code>, <code>ClosedCountableRange</code></li>
</ul>
<h3 id='exchange-code-nil-code-with-ruby' class='heading'>Exchange <code>nil</code> with Ruby</h3>

<p>The static <code><a href="Classes/RbObject.html#/s:11RubyGateway8RbObjectC03nilD0ACvpZ">RbObject.nilObject</a></code> represents Ruby <code>nil</code> and can be passed to Ruby
methods as a parameter or used in data structures.  As a short-hand you can use
literal Swift <code>nil</code> with APIs like <code><a href="Classes/RbObjectAccess.html#/s:11RubyGateway14RbObjectAccessC4callAA0cD0CSS_SayAA0cD11Convertible_pSgG4argss17DictionaryLiteralVySSAHG6kwArgstKF">RbObjectAccess.call(_:args:kwArgs:)</a></code>.</p>

<p>When Ruby returns <code>nil</code> to Swift it always comes through as an <code><a href="Classes/RbObject.html">RbObject</a></code>.  You
can compare this directly to <code><a href="Classes/RbObject.html#/s:11RubyGateway8RbObjectC03nilD0ACvpZ">RbObject.nilObject</a></code> or use <code><a href="Classes/RbObject.html#/s:11RubyGateway8RbObjectC5isNilSbvp">RbObject.isNil</a></code> to
test it.</p>

<p>If you want to include Ruby <code>nil</code> in a heterogenous array use this kind of
syntax:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">arr</span><span class="p">:</span> <span class="kt">RbObject</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s">"three"</span><span class="p">,</span> <span class="o">.</span><span class="n">nilObject</span><span class="p">]</span>
</code></pre>
<h3 id='deal-with-ruby-arrays' class='heading'>Deal with Ruby arrays</h3>

<p>There are a few approaches to make use of Ruby arrays depending on your goal.</p>

<ol>
<li>Convert the whole array to Swift using an initializer.  This eagerly converts
all the elements to Swift too and gives you an independent Swift array.</li>
<li>Use Ruby Array methods via <code><a href="Classes/RbObjectAccess.html#/s:11RubyGateway14RbObjectAccessC4callAA0cD0CSS_SayAA0cD11Convertible_pSgG4argss17DictionaryLiteralVySSAHG6kwArgstKF">RbObjectAccess.call(...)</a></code>.  Doing more work in
the Ruby domain can reduce the number of elements that need to be converted
to Swift types.</li>
<li>Use Swift collection methods using <code><a href="Classes/RbObject.html#/s:11RubyGateway8RbObjectC10collectionAA0cD10CollectionVvp">RbObject.collection</a></code>.  This gives access
to the Swift collection APIs.  It&rsquo;s more efficient that approach #1 if you
can avoid converting all the array elements and looks prettier if you are
aiming to mutate the array because the mutations happen in-place.</li>
</ol>
<h3 id='pass-a-symbol-as-an-argument' class='heading'>Pass a symbol as an argument</h3>

<p>Use <code><a href="Structs/RbSymbol.html">RbSymbol</a></code>.  Ruby:</p>
<pre class="highlight ruby"><code><span class="n">res</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="nf">meth</span><span class="p">(</span><span class="ss">:value</span><span class="p">)</span>
</code></pre>

<p>RubyGateway:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">res</span> <span class="o">=</span> <span class="k">try</span> <span class="n">obj</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="s">"meth"</span><span class="p">,</span> <span class="nv">args</span><span class="p">:</span> <span class="p">[</span><span class="kt">RbSymbol</span><span class="p">(</span><span class="s">"value"</span><span class="p">)])</span>
</code></pre>
<h3 id='pass-a-method-as-a-block' class='heading'>Pass a method as a block</h3>

<p>Use <code><a href="Structs/RbProc.html">RbProc</a></code> and <code><a href="Structs/RbSymbol.html">RbSymbol</a></code>.  Ruby:</p>
<pre class="highlight ruby"><code><span class="n">res</span> <span class="o">=</span> <span class="n">arr</span><span class="p">.</span><span class="nf">each</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:downcase</span><span class="p">)</span>
</code></pre>

<p>RubyGateway:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">res</span> <span class="o">=</span> <span class="k">try</span> <span class="n">arr</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="s">"each"</span><span class="p">,</span> <span class="nv">block</span><span class="p">:</span> <span class="kt">RbProc</span><span class="p">(</span><span class="nv">object</span><span class="p">:</span> <span class="kt">RbSymbol</span><span class="p">(</span><span class="s">"downcase"</span><span class="p">)))</span>
</code></pre>
<h3 id='pass-swift-code-as-a-block' class='heading'>Pass Swift code as a block</h3>

<p>Use an <code><a href="Classes/RbObjectAccess.html#/s:11RubyGateway14RbObjectAccessC4callAA0cD0CSS_SayAA0cD11Convertible_pSgG4argss17DictionaryLiteralVySSAHG6kwArgstKF">RbObjectAccess.call(...)</a></code> variant with a <code>blockCall</code> argument.  Ruby:</p>
<pre class="highlight ruby"><code><span class="n">obj</span><span class="p">.</span><span class="nf">meth</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="nb">puts</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">}</span>
</code></pre>

<p>RubyGateway:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">obj</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="s">"meth"</span><span class="p">)</span> <span class="p">{</span> <span class="n">args</span> <span class="k">in</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="o">.</span><span class="n">nilObject</span>
<span class="p">}</span>
</code></pre>

<p>If the method causes the Ruby object to capture the block as a proc then you
have to tell RubyGateway:</p>
<pre class="highlight swift"><code><span class="k">try</span> <span class="n">obj</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="s">"meth"</span><span class="p">,</span> <span class="nv">blockRetention</span><span class="p">:</span> <span class="o">.</span><span class="k">self</span><span class="p">)</span> <span class="p">{</span> <span class="n">args</span> <span class="k">in</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="o">.</span><span class="n">nilObject</span>
<span class="p">}</span>
</code></pre>
<h3 id='use-39-break-39-in-a-swift-block' class='heading'>Use &lsquo;break&rsquo; in a Swift block</h3>

<p>Throw an <code><a href="Structs/RbBreak.html">RbBreak</a></code>.  Ruby:</p>
<pre class="highlight ruby"><code><span class="n">result</span> <span class="o">=</span> <span class="n">array</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
   <span class="k">break</span> <span class="n">item</span> <span class="k">if</span> <span class="n">f</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>

<p>RubyGateway:</p>
<pre class="highlight swift"><code><span class="n">result</span> <span class="o">=</span> <span class="k">try</span> <span class="n">array</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="s">"each"</span><span class="p">)</span> <span class="p">{</span> <span class="n">args</span> <span class="k">in</span>
    <span class="k">if</span> <span class="nf">f</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="kt">RbBreak</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">.</span><span class="n">nilObject</span>
<span class="p">}</span>
</code></pre>
<h3 id='use-39-return-39-in-a-swift-block' class='heading'>Use &lsquo;return&rsquo; in a Swift block</h3>

<p>Can&rsquo;t do it - missing from the Ruby API.  Would probably have just been
confusing anyway.</p>
<h3 id='create-a-proc-with-swift-code' class='heading'>Create a Proc with Swift code</h3>

<p>Use <code><a href="Classes/RbObject.html#/s:11RubyGateway8RbObjectCA2CSayACGKc9blockCall_tcfc">RbObject.init(blockCall:)</a></code>.  Ruby:</p>
<pre class="highlight ruby"><code><span class="n">myProc</span> <span class="o">=</span> <span class="nb">proc</span> <span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">|</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="p">}</span>
</code></pre>

<p>RubyGateway:</p>
<pre class="highlight swift"><code><span class="n">myProc</span> <span class="o">=</span> <span class="kt">RbObject</span><span class="p">()</span> <span class="p">{</span> <span class="n">args</span> <span class="k">in</span>
    <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">}</span>
</code></pre>

<p>You must not let the <code><a href="Classes/RbObject.html">RbObject</a></code> expire while Ruby is holding on to the proc
object or the program will crash.  For example if you pass <code>myProc</code> to a
method of a Ruby object that captures the proc for later use, then you must
not let that Swift value go out of scope until the Ruby object has died or
otherwise guarantees never to invoke the proc.</p>
<h3 id='create-a-lambda-with-swift-code' class='heading'>Create a lambda with Swift code</h3>

<p>You can&rsquo;t: there&rsquo;s not much value and the API doesn&rsquo;t provide the argument
policing.  If you really need to then this kind of thing should get you
started:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">myLambda</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Ruby</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="s">"lambda"</span><span class="p">,</span> <span class="nv">blockRetention</span><span class="p">:</span> <span class="o">.</span><span class="n">returned</span><span class="p">)</span> <span class="p">{</span> <span class="n">args</span> <span class="k">in</span>
                   <span class="nf">print</span><span class="p">(</span><span class="s">"I got </span><span class="se">\(</span><span class="n">args</span><span class="o">.</span><span class="n">count</span><span class="se">)</span><span class="s"> args!"</span><span class="p">)</span>
                   <span class="k">return</span> <span class="o">.</span><span class="n">nilObject</span>
               <span class="p">}</span>
</code></pre>
<h3 id='access-class-variables' class='heading'>Access class variables</h3>

<p>Use <code><a href="Classes/RbObjectAccess.html#/s:11RubyGateway14RbObjectAccessC11getClassVarAA0cD0CSSKF">RbObjectAccess.getClassVar(_:)</a></code> <strong>on the class</strong>: RubyGateway goes like the
Ruby API not Ruby as written.  Ruby:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">MyClass</span>
  <span class="vc">@@count</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vc">@@count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>RubyGateway:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">myClass</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Ruby</span><span class="o">.</span><span class="nf">getClass</span><span class="p">(</span><span class="s">"MyClass"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="k">try</span> <span class="n">myClass</span><span class="o">.</span><span class="nf">getClassVar</span><span class="p">(</span><span class="s">"@@count"</span><span class="p">)</span>
</code></pre>
<h3 id='run-finalizers-before-process-exit' class='heading'>Run finalizers before process exit</h3>

<p>If you want to stop using Ruby and get on with something else, and
never come back to Ruby in the process, use <code><a href="Classes/RbGateway.html#/s:11RubyGateway02RbB0C7cleanups5Int32VyF">RbGateway.cleanup()</a></code>.</p>
<h2 id='work-with-ruby-complex-numbers' class='heading'>Work with Ruby complex numbers</h2>

<p>See <code><a href="Structs/RbComplex.html">RbComplex</a></code> for a thin wrapper to Ruby&rsquo;s <code>Complex</code> type.</p>
<h2 id='work-with-ruby-rational-numbers' class='heading'>Work with Ruby rational numbers</h2>

<p>See <code><a href="Structs/RbRational.html">RbRational</a></code> for a thin wrapper to Ruby&rsquo;s <code>Rational</code> type.</p>
<h2 id='implement-ruby-global-variables-in-swift' class='heading'>Implement Ruby Global Variables in Swift</h2>

<p>See <code><a href="Classes/RbGateway.html#/s:11RubyGateway02RbB0C15defineGlobalVarySS4name_AA0C6ObjectCyc3getyAGKc3settKF">RbGateway.defineGlobalVar(name:get:set:)</a></code>.  For example:</p>
<pre class="highlight swift"><code><span class="kt">Ruby</span><span class="o">.</span><span class="nf">defineGlobalVar</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"$epoch"</span><span class="p">,</span>
                     <span class="nv">get</span><span class="p">:</span> <span class="p">{</span> <span class="kt">RbObject</span><span class="p">(</span><span class="n">currentEpoch</span><span class="p">)</span> <span class="p">},</span>
                     <span class="nv">set</span><span class="p">:</span> <span class="p">{</span> <span class="n">newObj</span> <span class="k">in</span>
                            <span class="k">guard</span> <span class="k">let</span> <span class="nv">newEpoch</span> <span class="o">=</span> <span class="kt">Int</span><span class="p">(</span><span class="n">newObj</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
                                <span class="k">throw</span> <span class="kt">RbException</span><span class="p">(</span><span class="nv">message</span><span class="p">:</span> <span class="s">"Bad Epoch"</span><span class="p">)</span>
                            <span class="p">}</span>
                            <span class="nf">notifyNewEpoch</span><span class="p">(</span><span class="n">newEpoch</span><span class="p">)</span>
                          <span class="p">})</span>
</code></pre>
<h2 id='error-handling' class='heading'>Error Handling</h2>

<p>RubyGateway is very explicit about failure points.  Any Ruby method call can
raise an exception instead of terminating normally and this is reflected in the
throwable nature of most of the interesting RubyGateway methods.</p>

<p>Normally when writing Ruby scripts one doesn&rsquo;t care about this and just lets
the program crash, which happens very rarely after the debugging phase.  If you
are using RubyGateway though, there is presumably a lot more happening for you
and your users than the Ruby stuff &ndash; otherwise you&rsquo;d be writing Ruby, not
Swift.  I feel it does not make sense for a subsystem like this to decide how to
handle errors, so RubyGateway propagates all errors (<a href="#caveats-and-gotchas">except when it doesn&rsquo;t</a>).</p>

<p>And <code>try!</code> is always available for quick don&rsquo;t-care-about-errors environments.</p>
<h3 id='errors-exceptions' class='heading'>Errors + Exceptions</h3>

<p>All errors thrown are <code><a href="Enums/RbError.html">RbError</a></code> which is an enum of various interface errors
detected by RubyGateway and one case <code><a href="Enums/RbError.html#/s:11RubyGateway7RbErrorO13rubyExceptionAcA0cF0VcACmF">RbError.rubyException</a></code> that covers all
Ruby exceptions.</p>

<p>RubyGateway remembers the last few <code><a href="Enums/RbError.html">RbError</a></code>s that were generated and stores
them in the publicly available <code><a href="Enums/RbError.html#/s:11RubyGateway7RbErrorO7historyAC7HistoryVvpZ">RbError.history</a></code>.</p>
<h3 id='code-nil-code-failures' class='heading'><code>nil</code> failures</h3>

<p>Converting Ruby values to Swift types works differently: it happens using
failable initializers such as <code><a href="Extensions/String.html#/s:SS11RubyGatewayESSSgAA8RbObjectCcfc">String.init(_:)</a></code>.  These can fail for a variety
of reasons.  When they do, RubyGateway still internally generates an <code><a href="Enums/RbError.html">RbError</a></code>
and stores a copy in <code><a href="Enums/RbError.html#/s:11RubyGateway7RbErrorO7historyAC7HistoryVvpZ">RbError.history</a></code> even though it is not thrown.  This
means you can diagnose why a conversion failed:</p>
<pre class="highlight swift"><code><span class="k">guard</span> <span class="k">let</span> <span class="nv">score</span> <span class="o">=</span> <span class="kt">Float</span><span class="p">(</span><span class="n">scoreObj</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"Failed to get score back from Ruby: </span><span class="se">\(</span><span class="kt">RbError</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">mostRecent</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="k">return</span>
<span class="p">}</span>
</code></pre>
<h3 id='failable-adapter' class='heading'>Failable Adapter</h3>

<p><code><a href="Structs/RbFailableAccess.html">RbFailableAccess</a></code> is a non-throwing adapter for <code><a href="Classes/RbObject.html">RbObject</a></code> and <code><a href="Classes/RbGateway.html">RbGateway</a></code> that
returns <code>nil</code> when there is an error.  All it does is <code>try?</code> the
corresponding throwing method, meaning that the details of the failure are
available in <code><a href="Enums/RbError.html#/s:11RubyGateway7RbErrorO7historyAC7HistoryVvpZ">RbError.history</a></code>.</p>

<p>This is a steal of rough approach (the name is my fault) from the Python DML
sandbox with an eye to adding direct member lookup/callable to RubyGateway &ndash;
Swift subscripts can&rsquo;t throw.</p>

<p>I&rsquo;m not sure this is better than just writing <code>try?</code> which at least makes it
very difficult for readers to ignore the possibility of errors.</p>
<h2 id='concurrency' class='heading'>Concurrency</h2>

<p>RubyBridge inherits Ruby&rsquo;s threading model.  This means you can only use
RubyBridge APIs on the first/main thread and any other threads created by Ruby.</p>

<p><code><a href="Enums/RbThread.html">RbThread</a></code> provides some static helpers for creating Ruby threads and
relinquishing the GVL: consult the internet for further guidance.</p>
<h2 id='caveats-and-gotchas' class='heading'>Caveats and Gotchas</h2>
<h3 id='crashiness' class='heading'>Crashiness</h3>

<p>Certain <code><a href="Classes/RbObject.html">RbObject</a></code> methods forward to Ruby calls and crash (<code>fatalError()</code>)
if Ruby fails / the object doesn&rsquo;t support the method.  It&rsquo;s up to you to be
sure the Ruby objects you&rsquo;re dealing with are of the right type.  See
<code><a href="Classes/RbObject.html">RbObject</a></code> for more information on which these methods are.</p>
<h3 id='swift-closure-retention' class='heading'>Swift closure retention</h3>

<p>If you pass a Swift closure to a method as a block/proc/lambda that is used
by Ruby after that method finishes &ndash; ie. <em>not</em> the normal <code>#each</code>-type use &ndash;
then you need to understand <code><a href="Enums/RbBlockRetention.html">RbBlockRetention</a></code>.</p>

<p>The reason for all this is that calling Swift code from Ruby requires an
intermediate Swift object, and RubyGateway needs to tie the lifetime of that
Swift object to something else in the Swift world.</p>
<h3 id='block-arity' class='heading'>Block arity</h3>

<p>The Ruby runtime cannot tell the arity (number of expected arguments) of
blocks created by the Ruby C API / RubyGateway &ndash; <code>Proc#arity</code> always comes
out as -1.  This means that any Ruby code that tries to be clever by inspecting
the arity of its block will not work as expected.</p>

<p>Ruby&rsquo;s <code>Hash#each</code> suffers from this: instead of getting the key and value
passed separately you get one parameter, a two-element array of key and value.</p>
<h3 id='ruby-code-safety' class='heading'>Ruby code safety</h3>

<p>RubyGateway puts no restriction on what Ruby code can do: it can access the
filesystem, exit the process, and has complete access to the process&rsquo;s memory.</p>

<p>Ruby has historically had a <code>$SAFE</code> feature that did some amount of sandboxing.
This has been slowly removed over the years and what remains is a debugging
feature that can be enabled via <code><a href="Classes/RbGateway.html#/s:11RubyGateway02RbB0C11taintChecksSbvp">RbGateway.taintChecks</a></code>.</p>

<p>Dealing with actively hostile Ruby code is best done with a separate process
or container; several examples on github.</p>
<h2 id='using-the-cruby-api' class='heading'>Using the CRuby API</h2>

<p>The <a href="https://github.com/johnfairh/CRuby">CRuby</a> package provides access to as
much of the <code>libruby</code> API as makes it through the importer.  You can use this
in conjunction with RubyGateway to access more of the API than RubyGateway itself
provides.</p>

<p>Each <code><a href="Classes/RbObject.html">RbObject</a></code> wraps one <code>VALUE</code> keeping it safe from garbage collection.  You
can access that <code>VALUE</code> using <code><a href="Classes/RbObject.html#/s:11RubyGateway8RbObjectC04withA5ValuexxSuKc4call_tKlF">RbObject.withRubyValue(call:)</a></code>.</p>

<p>RubyGateway caches intern&#39;ed Ruby strings - you can access the cache using
<code><a href="Classes/RbGateway.html#/s:11RubyGateway02RbB0C5getIDSuSS3for_tKF">RbGateway.getID(for:)</a></code>.</p>

<p>Note that when you call the Ruby API and Ruby raises an exception, the process
immediately crashes unless you are running inside <code>rb_protect()</code> or equivalent.</p>
<h3 id='garbage-collection' class='heading'>Garbage collection</h3>

<p>The main risk using the <code>libruby</code> API is that GC happens too early on objects
you are trying to work with.</p>

<p>Ruby uses a mark and sweep GC.  This means the GC must be able to find the root
objects while they are live.  Two relevant techniques for this are:</p>

<ol>
<li>A list of known root objects;</li>
<li>Stack snooping.</li>
</ol>

<p><code><a href="Classes/RbObject.html">RbObject</a></code> holds one <code>VALUE</code> and stores it on the known list while the Swift
object is alive.  So if you solely use <code><a href="Classes/RbObject.html">RbObject</a></code>s then everything should be
fine. The only risk is that the Swift object dies before you expect it to;
the standard library includes <code>withExtendedLifetime(_:_:)</code> to help reason about
this.</p>

<p>Ruby GC scans the stack of each Ruby thread searching for <code>VALUE</code>s.  In very
old Ruby, the position of the stack was found from the address of a local
variable in an init function.  In modern Ruby, at least on Darwin &amp; Linux,
various pthread APIs are used instead which means there are no unwritten
rules about where the init function is called.</p>

<p>See <code>TestRbObject.testStackGc()</code> for a demo of this working in Swift.</p>

<p>This relies on the compiler actually placing <code>VALUE</code>s on the stack, which it is
not obliged to do.  In C the <code>RB_GC_GUARD()</code> macro forces its hand &ndash; a similar
thing should work in Swift but I haven&rsquo;t managed to find a situation where the
Swift compiler does <em>not</em> put it on the stack so can&rsquo;t test it.</p>
<h3 id='references' class='heading'>References</h3>

<ul>
<li><a href="http://silverhammermba.github.io/emberb/">Ruby C API Guide</a> - great guide to
the API.</li>
<li><a href="http://ruby-hacking-guide.github.io">Ruby Hacking Guide</a> - in-depth on how
Ruby (an old version of) works.</li>
<li><a href="https://blog.heroku.com/incremental-gc">Incremental GC in Ruby</a> - very
interesting overview of GC pre + @ 2.2.</li>
</ul>

          </div>
        </section>


      </article>
    </div>
    <section class="footer">
      <p>Distributed under the MIT license.  Maintained by <a class="link" href="mailto:johnfairh@gmail.com" target="_blank" rel="external">John Fairhurst</a>.</p>
      <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.9.3</a>-<a class="link" href="https://github.com/johnfairh/jazzy" target="_blank" rel="external">bebop</a>, originally a <a class="link" href="https://realm.io" target="_blank" rel="external">Realm</a> project.</p>
    </section>
  </body>
</div>
</html>
